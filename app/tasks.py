from redis import Redis
from rq import get_current_job
from app.model.results import fetchoutput
from app.run_simulator import simulator
import rq
import matplotlib.pyplot as plt
import os


def simulator_instance():
    rq.Queue('simulator', connection=Redis.from_url('redis://ec2-3-95-206-118.compute-1.amazonaws.com:6379'))
    modelresults = fetchoutput()
    return modelresults

def full_simulator():
    data = simulator()
    data.to_csv('test.csv', index=False)

def launch_simulator():
    queue = rq.Queue('full_simulator', connection=Redis.from_url('redis://ec2-3-95-206-118.compute-1.amazonaws.com:6379'))
    job = queue.enqueue('app.tasks.full_simulator')


def get_progress():
    fulljob = get_current_job(connection=Redis.from_url('redis://ec2-3-95-206-118.compute-1.amazonaws.com:6379'), job_class=full_simulator())
    return fulljob.meta.get('progress', 0) if fulljob is not None else 100

def graphing(df, strength_labels, fighting_labels, defending_labels):
    if os.path.exists("app/static/graph1.png"):
        os.remove("app/static/graph1.png")
    if os.path.exists("app/static/graph2.png"):
        os.remove("app/static/graph2.png")
    if os.path.exists("app/static/graph3.png"):
        os.remove("app/static/graph3.png")

    strength_values_template = [df.columns.values[1], df.columns.values[10], df.columns.values[19], df.columns.values[28], df.columns.values[37], df.columns.values[46], df.columns.values[55], df.columns.values[64], df.columns.values[73], df.columns.values[82], df.columns.values[91], df.columns.values[100], df.columns.values[109], df.columns.values[118], df.columns.values[127]]
    fighting_values_template = df.columns.values[376:].tolist()
    defending_values_template = df.columns.values[361:376].tolist()
    strength_values = []
    x = 0
    for i in strength_labels:
        strength_values.append(strength_values_template[x])
        x += 1

    fighting_values = []
    if len(fighting_labels) == 1:
        fighting_values = [fighting_values_template[0]]
    elif len(fighting_labels) == 3:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[14]]
    elif len(fighting_labels) == 6:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[14], fighting_values_template[15], fighting_values_template[27]]
    elif len(fighting_labels) == 10:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[27], fighting_values_template[28], fighting_values_template[39]]
    elif len(fighting_labels) == 15:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[39], fighting_values_template[40], fighting_values_template[50]]
    elif len(fighting_labels) == 21:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[50], fighting_values_template[51], fighting_values_template[60]]
    elif len(fighting_labels) == 28:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[60], fighting_values_template[61], fighting_values_template[69]]
    elif len(fighting_labels) == 36:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[69], fighting_values_template[70], fighting_values_template[77]]
    elif len(fighting_labels) == 45:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[8], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[21], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[33], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[44], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[54], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[63], fighting_values_template[69], fighting_values_template[70], fighting_values_template[71], fighting_values_template[77], fighting_values_template[78], fighting_values_template[84]]
    elif len(fighting_labels) == 55:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[8], fighting_values_template[9], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[21], fighting_values_template[22], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[33], fighting_values_template[34], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[44], fighting_values_template[45], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[54], fighting_values_template[55], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[63], fighting_values_template[64], fighting_values_template[69], fighting_values_template[70], fighting_values_template[71], fighting_values_template[72], fighting_values_template[77], fighting_values_template[78], fighting_values_template[79], fighting_values_template[84], fighting_values_template[85], fighting_values_template[90]]
    elif len(fighting_labels) == 66:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[8], fighting_values_template[9], fighting_values_template[10], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[21], fighting_values_template[22], fighting_values_template[23], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[33], fighting_values_template[34], fighting_values_template[35], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[44], fighting_values_template[45], fighting_values_template[46], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[54], fighting_values_template[55], fighting_values_template[56], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[63], fighting_values_template[64], fighting_values_template[65], fighting_values_template[69], fighting_values_template[70], fighting_values_template[71], fighting_values_template[72], fighting_values_template[73], fighting_values_template[77], fighting_values_template[78], fighting_values_template[79], fighting_values_template[80], fighting_values_template[84], fighting_values_template[85], fighting_values_template[86], fighting_values_template[90], fighting_values_template[91], fighting_values_template[95]]
    elif len(fighting_labels) == 78:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[8], fighting_values_template[9], fighting_values_template[10], fighting_values_template[11], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[21], fighting_values_template[22], fighting_values_template[23], fighting_values_template[24], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[33], fighting_values_template[34], fighting_values_template[35], fighting_values_template[36], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[44], fighting_values_template[45], fighting_values_template[46], fighting_values_template[47], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[54], fighting_values_template[55], fighting_values_template[56], fighting_values_template[57], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[63], fighting_values_template[64], fighting_values_template[65], fighting_values_template[66], fighting_values_template[69], fighting_values_template[70], fighting_values_template[71], fighting_values_template[72], fighting_values_template[73], fighting_values_template[74], fighting_values_template[77], fighting_values_template[78], fighting_values_template[79], fighting_values_template[80], fighting_values_template[81], fighting_values_template[84], fighting_values_template[85], fighting_values_template[86], fighting_values_template[87], fighting_values_template[90], fighting_values_template[91], fighting_values_template[92], fighting_values_template[95], fighting_values_template[96], fighting_values_template[99]]
    elif len(fighting_labels) == 91:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[8], fighting_values_template[9], fighting_values_template[10], fighting_values_template[11], fighting_values_template[12], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[21], fighting_values_template[22], fighting_values_template[23], fighting_values_template[24], fighting_values_template[25], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[33], fighting_values_template[34], fighting_values_template[35], fighting_values_template[36], fighting_values_template[37], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[44], fighting_values_template[45], fighting_values_template[46], fighting_values_template[47], fighting_values_template[48], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[54], fighting_values_template[55], fighting_values_template[56], fighting_values_template[57], fighting_values_template[58], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[63], fighting_values_template[64], fighting_values_template[65], fighting_values_template[66], fighting_values_template[67], fighting_values_template[69], fighting_values_template[70], fighting_values_template[71], fighting_values_template[72], fighting_values_template[73], fighting_values_template[74], fighting_values_template[75], fighting_values_template[77], fighting_values_template[78], fighting_values_template[79], fighting_values_template[80], fighting_values_template[81], fighting_values_template[82], fighting_values_template[84], fighting_values_template[85], fighting_values_template[86], fighting_values_template[87], fighting_values_template[88], fighting_values_template[90], fighting_values_template[91], fighting_values_template[92], fighting_values_template[93], fighting_values_template[95], fighting_values_template[96], fighting_values_template[97], fighting_values_template[99], fighting_values_template[100], fighting_values_template[102]]
    elif len(fighting_labels) == 105:
        fighting_values = [fighting_values_template[0], fighting_values_template[1], fighting_values_template[2], fighting_values_template[3], fighting_values_template[4], fighting_values_template[5], fighting_values_template[6], fighting_values_template[7], fighting_values_template[8], fighting_values_template[9], fighting_values_template[10], fighting_values_template[11], fighting_values_template[12], fighting_values_template[13], fighting_values_template[14], fighting_values_template[15], fighting_values_template[16], fighting_values_template[17], fighting_values_template[18], fighting_values_template[19], fighting_values_template[20], fighting_values_template[21], fighting_values_template[22], fighting_values_template[23], fighting_values_template[24], fighting_values_template[25], fighting_values_template[26], fighting_values_template[27], fighting_values_template[28], fighting_values_template[29], fighting_values_template[30], fighting_values_template[31], fighting_values_template[32], fighting_values_template[33], fighting_values_template[34], fighting_values_template[35], fighting_values_template[36], fighting_values_template[37], fighting_values_template[38], fighting_values_template[39], fighting_values_template[40], fighting_values_template[41], fighting_values_template[42], fighting_values_template[43], fighting_values_template[44], fighting_values_template[45], fighting_values_template[46], fighting_values_template[47], fighting_values_template[48], fighting_values_template[49], fighting_values_template[50], fighting_values_template[51], fighting_values_template[52], fighting_values_template[53], fighting_values_template[54], fighting_values_template[55], fighting_values_template[56], fighting_values_template[57], fighting_values_template[58], fighting_values_template[59], fighting_values_template[60], fighting_values_template[61], fighting_values_template[62], fighting_values_template[63], fighting_values_template[64], fighting_values_template[65], fighting_values_template[66], fighting_values_template[67], fighting_values_template[68], fighting_values_template[69], fighting_values_template[70], fighting_values_template[71], fighting_values_template[72], fighting_values_template[73], fighting_values_template[74], fighting_values_template[75], fighting_values_template[76], fighting_values_template[77], fighting_values_template[78], fighting_values_template[79], fighting_values_template[80], fighting_values_template[81], fighting_values_template[82], fighting_values_template[83], fighting_values_template[84], fighting_values_template[85], fighting_values_template[86], fighting_values_template[87], fighting_values_template[88], fighting_values_template[89], fighting_values_template[90], fighting_values_template[91], fighting_values_template[92], fighting_values_template[93], fighting_values_template[94], fighting_values_template[95], fighting_values_template[96], fighting_values_template[97], fighting_values_template[98], fighting_values_template[99], fighting_values_template[100], fighting_values_template[101], fighting_values_template[102]]

    defending_values = []
    x = 0
    for i in defending_labels:
        defending_values.append(defending_values_template[x])
        x += 1

    ax = df.plot(kind='line', x='rounds', y=strength_values)
    ax.legend(strength_labels)
    ax.set_ylabel("strength")
    plt.title('Militant Strength')
    plt.savefig('app/static/graph1.png')
    plt.clf()
    ax = df.plot(kind='line', x='rounds', y=fighting_values)
    ax.legend(fighting_labels)
    ax.set_ylabel("probability of fighting")
    plt.title('Militant Fighting')
    plt.savefig('app/static/graph2.png')
    plt.clf()
    ax = df.plot(kind='line', x='rounds', y=defending_values)
    ax.legend(defending_labels)
    ax.set_ylabel("incidents of defending")
    plt.title('Community Defending')
    plt.savefig('app/static/graph3.png')
    plt.clf()
